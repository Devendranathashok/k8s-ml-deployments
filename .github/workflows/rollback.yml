name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      deployment_type:
        description: 'Deployment type to rollback'
        required: true
        type: choice
        options:
          - kserve
          - standard
      revision:
        description: 'Revision to rollback to (leave empty for previous)'
        required: false
        default: ''

env:
  K8S_NAMESPACE: ml-models

jobs:
  rollback-standard:
    name: Rollback Standard K8s Deployment
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'standard'
    environment:
      name: production-standard

    steps:
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Check rollout history
        run: |
          kubectl rollout history deployment/ml-model-deployment

      - name: Rollback deployment
        run: |
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            kubectl rollout undo deployment/ml-model-deployment --to-revision=${{ github.event.inputs.revision }}
          else
            kubectl rollout undo deployment/ml-model-deployment
          fi

      - name: Wait for rollback
        run: |
          kubectl rollout status deployment/ml-model-deployment --timeout=5m

      - name: Verify rollback
        run: |
          kubectl get deployments
          kubectl get pods

          # Run health check
          kubectl run test-pod --image=curlimages/curl --rm -i --restart=Never -- \
            curl -f http://ml-model-service/health

  rollback-kserve:
    name: Rollback KServe InferenceService
    runs-on: ubuntu-latest
    if: github.event.inputs.deployment_type == 'kserve'
    environment:
      name: production-kserve

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Get current InferenceService
        run: |
          kubectl get inferenceservice iris-model -n ${{ env.K8S_NAMESPACE }} -o yaml > current-inferenceservice.yaml
          cat current-inferenceservice.yaml

      - name: Rollback to previous version
        run: |
          if [ -n "${{ github.event.inputs.revision }}" ]; then
            # Checkout specific revision
            git checkout ${{ github.event.inputs.revision }} -- k8s/kserve-inferenceservice.yaml
          else
            # Get previous commit
            git checkout HEAD~1 -- k8s/kserve-inferenceservice.yaml
          fi

      - name: Apply rollback
        run: |
          kubectl apply -f k8s/kserve-inferenceservice.yaml -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for rollback
        run: |
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            status=$(kubectl get inferenceservice iris-model -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "False")
            if [ "$status" = "True" ]; then
              echo "Rollback successful!"
              exit 0
            fi
            echo "Waiting for rollback to complete... ($elapsed/$timeout seconds)"
            sleep 10
            elapsed=$((elapsed + 10))
          done
          echo "Timeout during rollback"
          kubectl describe inferenceservice iris-model -n ${{ env.K8S_NAMESPACE }}
          exit 1

      - name: Verify rollback
        run: |
          kubectl get inferenceservice iris-model -n ${{ env.K8S_NAMESPACE }}
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}

  notify-rollback:
    name: Notify Rollback Status
    runs-on: ubuntu-latest
    needs: [rollback-standard, rollback-kserve]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Rollback completed!"
          echo "Standard K8s: ${{ needs.rollback-standard.result }}"
          echo "KServe: ${{ needs.rollback-kserve.result }}"
          # Add notification service here (Slack, Discord, Email, etc.)
