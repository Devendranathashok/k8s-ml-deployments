name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'k8s/**'
      - '.github/workflows/**'

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest flake8 black isort

      - name: Run black (code formatting)
        run: |
          black --check . || echo "Code formatting issues found (run 'black .' to fix)"

      - name: Run flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Train model
        run: |
          python train_model.py

      - name: Test model loading
        run: |
          python -c "import joblib; model = joblib.load('model/iris_model.pkl'); print('Model loaded successfully')"

      - name: Start Flask app
        run: |
          python app.py &
          APP_PID=$!
          sleep 5

      - name: Test API endpoints
        run: |
          # Health check
          curl -f http://localhost:5000/health

          # Model info
          curl -f http://localhost:5000/model/info

          # Prediction
          curl -X POST http://localhost:5000/predict \
            -H "Content-Type: application/json" \
            -d '{"features": [5.1, 3.5, 1.4, 0.2]}' \
            -f

          # Batch prediction
          curl -X POST http://localhost:5000/predict/batch \
            -H "Content-Type: application/json" \
            -d '{"samples": [[5.1, 3.5, 1.4, 0.2], [6.2, 2.9, 4.3, 1.3]]}' \
            -f

  docker-build-test:
    name: Test Docker Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python (for model training)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Train model
        run: |
          pip install -r requirements.txt
          python train_model.py

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ml-model:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Docker container
        run: |
          docker run -d -p 5000:5000 --name ml-model-test ml-model:test
          sleep 10

      - name: Test container health
        run: |
          curl -f http://localhost:5000/health

      - name: Test container prediction
        run: |
          curl -X POST http://localhost:5000/predict \
            -H "Content-Type: application/json" \
            -d '{"features": [5.1, 3.5, 1.4, 0.2]}' \
            -f

      - name: Check container logs
        if: always()
        run: |
          docker logs ml-model-test

  validate-k8s-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

      - name: Validate standard K8s manifests
        run: |
          kubeval k8s/deployment.yaml
          kubeval k8s/hpa.yaml
          kubeval k8s/ingress.yaml

      - name: Validate KServe manifest
        run: |
          kubectl apply --dry-run=client -f k8s/kserve-inferenceservice.yaml || echo "KServe CRD validation skipped (requires cluster)"

      - name: Check for common issues
        run: |
          # Check for 'latest' tag usage
          if grep -r "image:.*:latest" k8s/; then
            echo "Warning: Using 'latest' tag in manifests. Consider using specific versions."
          fi

          # Check for resource limits
          if ! grep -q "limits:" k8s/deployment.yaml; then
            echo "Warning: No resource limits defined in deployment"
          fi
